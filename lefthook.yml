pre-commit:
  parallel: true
  commands:
    ruff-format:
      run: |
        sh -c '
          set -eu
          files=$(git diff --cached --name-only --diff-filter=ACMR | grep -E "\\.py$" || true)
          [ -z "$files" ] && exit 0
          uv run ruff format $files
          git add $files
        '
    ruff-check:
      run: |
        sh -c '
          set -eu
          files=$(git diff --cached --name-only --diff-filter=ACMR | grep -E "\\.py$" || true)
          [ -z "$files" ] && exit 0
          uv run ruff check $files
        '

pre-push:
  parallel: true
  commands:
    ty-check:
      run: |
        sh -c '
          set -eu

          if git rev-parse --abbrev-ref --symbolic-full-name "@{u}" >/dev/null 2>&1; then
            range="@{u}...HEAD"
          elif git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            range="HEAD~1..HEAD"
          else
            range="HEAD"
          fi

          files=$(git diff --name-only --diff-filter=ACMR "$range" | grep -E "^src/.*\\.py$" || true)
          [ -z "$files" ] && exit 0

          uv run ty check
        '
