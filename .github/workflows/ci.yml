name: ci

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  checks:
    runs-on: ubuntu-latest

    env:
      UV_FROZEN: "1"

    steps:
      - uses: actions/checkout@v6

      - uses: astral-sh/setup-uv@v7
        with:
          version: "0.9.18"

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13.11"

      - name: Sync dependencies
        run: uv sync --group dev

      - name: Lint
        run: uv run ruff check .

      - name: Type check
        run: uv run ty check

      - name: Verify model registry
        run: uv run python scripts/verify_model_registry.py

  unit_tests:
    runs-on: ubuntu-latest
    needs: [checks]

    env:
      UV_FROZEN: "1"
      COVERAGE_FILE: .coverage.unit

    steps:
      - uses: actions/checkout@v6

      - uses: astral-sh/setup-uv@v7
        with:
          version: "0.9.18"

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13.11"

      - name: Sync dependencies
        run: uv sync --group dev

      - name: Tests (unit)
        run: uv run pytest -q -m "not db" --cov=app --cov-report=term

      - name: Upload unit coverage data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-unit
          path: .coverage.unit
          if-no-files-found: error

  db_tests:
    runs-on: ubuntu-latest
    needs: [checks]

    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_USER: app
          POSTGRES_PASSWORD: app
          POSTGRES_DB: app
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U app -d app"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20

    env:
      DATABASE_URL: postgresql+psycopg://app:app@localhost:5432/app
      RUN_DB_TESTS: "1"
      UV_FROZEN: "1"
      COVERAGE_FILE: .coverage.db

    steps:
      - uses: actions/checkout@v6

      - uses: astral-sh/setup-uv@v7
        with:
          version: "0.9.18"

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13.11"

      - name: Sync dependencies
        run: uv sync --group dev

      - name: Migrate
        run: uv run alembic upgrade head

      - name: Tests (db)
        run: uv run pytest -q -m db --cov=app --cov-report=term

      - name: Upload db coverage data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-db
          path: .coverage.db
          if-no-files-found: error

  coverage:
    runs-on: ubuntu-latest
    needs: [unit_tests, db_tests]

    env:
      UV_FROZEN: "1"

    steps:
      - uses: actions/checkout@v6

      - uses: astral-sh/setup-uv@v7
        with:
          version: "0.9.18"

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13.11"

      - name: Sync dependencies
        run: uv sync --group dev

      - name: Download coverage data
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          merge-multiple: true

      - name: Combine coverage
        run: |
          uv run coverage combine .coverage.unit .coverage.db
          uv run coverage xml -o coverage.xml
          uv run coverage report -m

      - name: Coverage summary
        if: always()
        run: |
          uv run python - <<'PY'
          from __future__ import annotations

          import os
          import pathlib
          import xml.etree.ElementTree as ET

          path = pathlib.Path("coverage.xml")
          if not path.exists():
            raise SystemExit(0)

          root = ET.parse(path).getroot()
          line_rate = float(root.attrib.get("line-rate", "0")) * 100
          branch_rate = float(root.attrib.get("branch-rate", "0")) * 100

          lines_covered = root.attrib.get("lines-covered")
          lines_valid = root.attrib.get("lines-valid")
          branches_covered = root.attrib.get("branches-covered")
          branches_valid = root.attrib.get("branches-valid")

          summary = [
            "### Coverage",
            f"- Lines: {line_rate:.1f}%" + (
              f" ({lines_covered}/{lines_valid})" if lines_covered and lines_valid else ""
            ),
            f"- Branches: {branch_rate:.1f}%" + (
              f" ({branches_covered}/{branches_valid})" if branches_covered and branches_valid else ""
            ),
            "",
            "Artifact: `coverage` (coverage.xml / .coverage)",
            "",
          ]

          with open(os.environ["GITHUB_STEP_SUMMARY"], "a", encoding="utf-8") as f:
            f.write("\n".join(summary))
          PY

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: |
            coverage.xml
            .coverage
          if-no-files-found: error
